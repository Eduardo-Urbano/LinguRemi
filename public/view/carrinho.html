<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Carrinho</title>
    <link rel="stylesheet" href="../assets/css/output.css">
    <link rel="shortcut icon" href="../assets/images/icones/logo1.ico" type="image/x-icon">
</head>
<body class="flex flex-col min-h-screen">

    <header class="flex justify-between items-center px-5 shadow-sm">
        <nav class="flex flex-row gap-x-6 text-xl w-1/3">
            <ul class="flex flex-row space-x-6">
                <li><a href="./produtos.html">Produtos</a></li>
                <li><a href="#footer">Sobre n√≥s</a></li>
                <li><a href="./blog.html">Blog</a></li>
            </ul>
        </nav>
        <div class="flex justify-center w-1/3">
            <img class="w-62" src="../assets/images/logo/logo1.png">
        </div>
        <nav class="flex flex-row gap-x-6 text-xl w-1/3 justify-end">
            <ul class="flex flex-row space-x-6">
                <li><a id="ident0" class="flex" href="#">Login</a></li>
                <li><a id="ident1" class="hidden" href="./perfil.html"></a></li>
                <li><a href="./index.html"><img src="../assets/images/icones/Home.png" alt="P√°gina inicial"></a></li>
                <li><a href="./carrinho.html"><img src="../assets/images/icones/carrinho2.png" alt="Meu Carrinho"></a></li>
            </ul>
        </nav>
    </header>

    <div class="flex flex-row gap-6 my-5 p-3.5 bg-white">
        <section id="minhasCompras" class="w-3/4 min-h-[500px] bg-white rounded-2xl p-4 shadow-2xl">
            <main class="container mx-auto p-4 px-4 pb-12">
                <div id="cards1" class="flex flex-col gap-6"></div>
            </main>
        </section>

        <div id="finalizarCompra" class="text-white p-4 flex flex-col gap-3.5 w-1/4 min-h-[500px] max-h-[900px] bg-linear-to-br from-gray-500 from-1% via-gray-700 via-9% to-black to-90% rounded-2xl shadow-2xl">
            <div id="carrinho"></div>
            <h2 id="total" class="text-2xl"><strong>Total:</strong></h2>
            <button type="button" class="text-4xl" id="btnFinalizar"><strong>Finalizar compra</strong></button>
        </div>
    </div>

    <footer id="footer" class="text-gray-200 pt-32 bg-linear-to-br from-gray-500 from-1% via-gray-700 via-9% to-black to-90%">
        <div class="container mb-0 mx-auto px-6">
            <div class="flex flex-col md:flex-row justify-between gap-6">
                <div class="md:w-2/5 min-w-0">
                    <a href="#">
                        <img class="mt-0 max-h-1/4 max-w-10/12 place-self-center" src="../assets/images/icones/logo1.ico" alt="LinguRemi">
                    </a>
                    <p class="mt-6 text-gray-300 wrap-break-words max-w-full overflow-hidden whitespace-normal">
                        Lorem ipsum dolor sit amet consectetur adipisicing elit.
                    </p>
                </div>
            </div>
        </div>
        <div class="text-center mt-1 pb-10">¬©LinguR√©mi 2025</div>
    </footer>    

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const cartContainer = document.getElementById("cards1");
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const carrinhoTotal = document.getElementById("carrinho");

        if (cart.length === 0) {
            cartContainer.innerHTML = "<p class='text-center text-xl'>Seu carrinho est√° vazio.</p>";
            return;
        }

        cart.forEach((item, index) => {
            const tipo = item.tipoQuantidade || "unidade";
            const imagem = item.imagem || "https://via.placeholder.com/150";

            let preco = parseFloat(item.preco.toString().replace(",", "."));
            if (isNaN(preco)) preco = 0;

            let totalItem = tipo === "unidade" ? preco * item.quantidade : preco * item.quantidade * 10;

            // Card resumo
            const card2 = document.createElement("div");
            card2.innerHTML = `
                <h1 class="text-xl font-semibold">${item.nome}</h1>
                <p class="text-lg">
                    R$ ${preco.toFixed(2).replace(".", ",")} x 
                    <span id="qtd-${index}">${item.quantidade}</span> =
                    <strong id="subtotal-${index}">R$ ${totalItem.toFixed(2).replace(".", ",")}</strong>
                </p>
            `;
            carrinhoTotal.appendChild(card2);

            // Campo quantidade
            let campoQuantidade = tipo === "unidade"
                ? `<label class="font-medium mb-1">Quantidade:</label>
                   <input type="number" min="5" value="${item.quantidade}" data-index="${index}" class="input-quantidade border rounded p-1 w-20 text-center" />
                   <span class="ml-1 text-sm text-gray-600">un</span>`
                : `<label class="font-medium mb-1">Peso:</label>
                   <input type="number" step="0.100" min="0.300" value="${item.quantidade}" data-index="${index}" class="input-quantidade border rounded p-1 w-20 text-center" />
                   <span class="text-sm text-gray-600">kg</span>`;

            // Card principal
            const card = document.createElement("div");
            card.className = "bg-white rounded-xl shadow-lg overflow-hidden justify-between flex items-center";
            card.innerHTML = `
                <div class="flex flex-row items-center">
                    <img src="${imagem}" alt="${item.nome}" class="w-60 h-48 object-cover">
                    <div class="flex flex-col w-full ml-5 max-w-100">
                        <h2 class="font-bold text-lg">${item.nome}</h2>
                        <button type="button" class="btn-remove rounded-xl bg-red-400 hover:bg-red-700 text-white px-3 py-1 mt-3 w-36">Remover Item</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">${campoQuantidade}</div>        
                <h1 class="text-gray-700 mr-5">Pre√ßo: R$ ${preco.toFixed(2).replace(".", ",")}</h1>
            `;
            cartContainer.appendChild(card);

            // Remover item
            const btnRemove = card.querySelector(".btn-remove");
            if (btnRemove) {
                btnRemove.addEventListener("click", () => {
                    cart.splice(index, 1);
                    localStorage.setItem("cart", JSON.stringify(cart));
                    card.remove();
                    card2.remove();
                    updateTotal();
                });
            }

            // Atualizar quantidade
           card.querySelector(".input-quantidade").addEventListener("input", (e) => {
                const novaQuantidade = Number(e.target.value);
                const itemIndex = e.target.getAttribute("data-index");

                // Atualiza quantidade no carrinho
                cart[itemIndex].quantidade = novaQuantidade;
                localStorage.setItem("cart", JSON.stringify(cart));
                

                const item = cart[itemIndex];
                const preco = parseFloat(item.preco.toString().replace(",", ".")) || 0;
                const tipo = item.tipoQuantidade || "unidade";

                const novoSubtotal = tipo === "unidade"
                ? preco * novaQuantidade
                : preco * novaQuantidade * 10

                const qtdElemento = document.getElementById(`qtd-${itemIndex}`);
                if (qtdElemento) {
                    qtdElemento.textContent = novaQuantidade;
                }

                const subtotalElemento = document.getElementById(`subtotal-${itemIndex}`);
                if (subtotalElemento) {
                    subtotalElemento.textContent = `R$ ${novoSubtotal.toFixed(2).replace(".", ",")}`;
                }

                updateTotal();
            });
            cartContainer.appendChild(card);
            updateTotal()
        });

        // Atualiza total
        function updateTotal() {
            const total = cart.reduce((sum, item) => {
                const precoItem = parseFloat(item.preco.toString().replace(",", ".")) || 0;
                return sum + (item.tipoQuantidade === "peso" ? precoItem * item.quantidade * 10 : precoItem * item.quantidade);
            }, 0);
            document.getElementById("total").textContent = `Total: R$ ${total.toFixed(2).replace(".", ",")}`;
        }

        updateTotal();

        // Bot√£o finalizar compra
        const btnFinalizar = document.getElementById("btnFinalizar");
        btnFinalizar.addEventListener("click", async () => {
            if (cart.length === 0) {
                alert("O carrinho est√° vazio!");
                return;
            }

            // ‚úÖ usa a mesma fun√ß√£o de c√°lculo para garantir consist√™ncia
            const total = calcularTotal();

            const payload = {
                emailTransferencia: localStorage.getItem("emailUser") || "usuario@teste.com",
                valorTransferencia: total, // üîπ valor total correto e atualizado
                descTransferencia: "Compra realizada via site",
                quantidadeTransferencia: cart.reduce((acc, item) => acc + item.quantidade, 0),
                receitasTransferencia: cart.map(item => ({
                    id: item.id,
                    quantidade: item.quantidade
                }))
            };

            try {
                const response = await fetch("http://localhost:8080/historico/adicionar", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Erro: ${response.statusText}`);

                alert("Compra realizada com sucesso!");
                localStorage.removeItem("cart");
                window.location.reload();
            } catch (error) {
                console.error(error);
                alert("Ocorreu um erro ao finalizar a compra.");
            }
        });

        // üîß fun√ß√£o reaproveit√°vel
        function calcularTotal() {
            return cart.reduce((sum, item) => {
                const precoItem = parseFloat(item.preco.toString().replace(",", ".")) || 0;
                return sum + (item.tipoQuantidade === "peso"
                    ? precoItem * item.quantidade * 10
                    : precoItem * item.quantidade);
            }, 0);
        }
    });
    </script>

</body>
</html>
